## 控制单元总结

### 一、串口通信 

树莓派的内存只有16GB，且很多深度学习框架并没有支持该系统的可执行文件，甚至需要自己去编译配置，那么这是一项极其耗时且费力的工作。在这一部分我将展示如何利用Socket进行windows和LInux的串口通信（推荐），如果你仍然执着于模型部署，那么请直接跳至第二部分。

#### 1 什么是socket？

首先我们需要理解什么是网络编程，网络编程就是编写程序使两台联网的计算机之间能够进行通信，即能相互交换数据。

然后我们再来理解socket，socket即套接字，是操作系统提供的独立于具体协议的网络编程接口，使用socket可以很方便地编写出数据传输程序，实现计算机之间的通信，而无需考虑其背后的原理。

socket 的一个典型应用就是 Web 服务器和浏览器：浏览器获取用户输入的 URL，向服务器发起请求，服务器分析接收到的 URL，将对应的网页内容返回给浏览器，浏览器再经过解析和渲染，就将文字、图片、视频等元素呈现给用户。

#### 2 基于python的socket传输

##### 2.1 环境配置

*具体的配置环境过程见第二部分，这里只展示包含socket的安装过程.*

注意！这里windows和树莓派都需要安装socket，届时需要分别启动进行通信。

```python
pip install socket
```

##### 2.2 代码详解

Socket通信分为客户端与服务端。顾名思义，当二者同时启动时，客户端连接设置好的主机ip和串口（此处分别为192.168.149.1和22），发送已编码的字符串数据（这里包含3个参数：X坐标，Y坐标，棋局状态），服务端被连接后接受数据，并解码后传递给机械臂执行放置五子棋的动作。

- transmit.py，即客户端：

```python
import socket
new_socket = socket.socket() #创建socket对象
ip = "192.168.149.1"          # 树莓派地址
port = 22               # 设置默认端口
new_socket.connect((ip,port))
i=0
while 1:
    #这里只是接受输入，若是和树莓派配合只需要分装一个小函数接受博弈单元的输入即可
    #如：x,y,z = result(),result()为博弈单元结果
    x = input()
    y= input()
    z = input()
    t = x+","+y+","+z
    new_socket.send(t.encode())
    i+=1
    if i==4:
        back_str = new_socket.recv(1024).decode() #结束数据
        break
new_socket.close() #关闭客户端
print("客户端结束运行")
```

- Sever.py，即服务器端：

```python
import socket

def main():
    '''
    socket communication between Windows and Linux
    '''
    #服务端
    new_socket = socket.socket()         # 创建 socket 对象
    ip = "192.168.149.1"          # 获取本地主机名
    port = 22               # 设置端口
    new_socket.bind((ip, port))        # 绑定端口
    new_socket.listen(20)                 # 等待客户端连接并设置最大连接数
    while True:
        init_position()
        new_cil, addr = new_socket.accept()     # 建立客户端连接。
        print('新进来的客户端的地址：', addr)
        t = new_cil.recv(1024).decode()
        t = t.split(',')
        #——————————————————————————————
        put_chess(int(t[0]),int(t[1]))   #控制树莓派进行下棋的函数put_chess()
        #——————————————————————————————
        if(int(t[2]==0)):
            new_cil.close()                # 关闭连接
    
main()
```

#### 3 使用详解

==首先启用服务端！首先启用服务端！首先启用服务端！重要的事情说三遍！==

之后再开启客户端，进行通信服务。

##### 3.1 遇到的问题及解决方法

Socket通信对端口并发要求很严格，往往因为调试的时候启动次数过多导致端口被占用，如下：

![image-20210726220832383-16273085145031](https://user-images.githubusercontent.com/60317828/127079293-d874bd19-c96a-4987-b140-c2b050c81ca3.png)

这里先观察对应端口进程，之后杀死进程即可，如下：

![image-20210726220847766-16273085291192](https://user-images.githubusercontent.com/60317828/127079307-c5152c09-04fa-4a2a-a08a-15eba1595b8f.png)

具体代码（别说你不会使Linux）：

```
$ sudo lsof -i:22
$ sudo kill -9 21227
```

### 二、环境配置

#### 1 前言

首先说明下为什么进行环境配置，以及为什么不需要它。

模型是可以在本地进行训练得到的，但是假如要把模型部署到树莓派上的话，至少环境能跑推断。博弈单元和视觉单元涉及许多深度学习甚至强化学习的方法，如果环境不行的话根本运行不了，更不用说操控机械臂了。

但是，这也是不必须的，在给树莓派安装python的基础上。只需要用第一部分讲的socket进行通信，就可以让机械臂只负责控制，而不用跑推断了。

#### 2 环境配置详解

##### 2.1 硬件环境

![image-20210726221924932](https://user-images.githubusercontent.com/60317828/127079355-882d8f1c-f426-405c-9be1-91b89a4cb54a.png)

观察到是32为Linux系统，注意下载包的时候要==aarch64==的。

##### 2.2 安装python

这个就不多说了，网上一堆教程，下一个linux版本的python就行

##### 2.3 重定向python3

因为Linux系统本身是安装好python2 和 python3的，但是有些python3的版本太老了，没法直接使，所以要么按2.2下载完重定向，要么直接重定向，如下：

![image-20210726221847086-16273091280673](https://user-images.githubusercontent.com/60317828/127079363-583cf065-271d-429a-abba-fd9a38a50a47.png)

##### 2.4 第三方库安装

```python
sudo pip install h5py==2.9.0 Keras==2.3.1 numpy==1.20.3 opencv-python==4.1.1.26 scikit-image==0.18.1 scipy==1.5.1 tensorflow==2.0.0
```

==*注意要加超级用户 sudo ！*==

##### 2.5 深度学习框架安装

这个是真的狗，我记得我在这边搞了15个小时左右才弄完，主要原因是官网上没有树莓派的whl文件，其他的根本用不了。有大佬说可以直接编译，但我怕搞崩。毕竟2000￥一个机械臂啊~

pytorch的话记得是直接pip install的，tensorflow直接下载别人编译好的whl文件（在资源那一栏可以直接下载）

安装

done！

### 三、机械臂控制

#### **技术方案概述：**

该部分工作主要包括两部分，分别是控制机械臂对五子棋进行抓取和放置。抓取部分我们采用主动“喂”棋子的方式进行，放置部分包含正逆运动学和深度学习两种方式进行计算和控制。

#### 1 **抓取函数**

在经过大量的实验后，我们最终采用人为“喂”给机械臂五子棋的方案。

为防止机械臂下完棋子后遮挡摄像头识别的视线，且以一种更易交互的形式拿到棋子，我们编写了其初始位置函数，具体参数如下：

|  2   |  3   |  4   |  5   |  6   | time sleep |
| :--: | :--: | :--: | :--: | :--: | :--------: |
| 500  | 300  | 800  | 700  | 850  |   0.5 s    |

#### 2 **放置函数**

##### 2.1 **映射函数**

当博弈单元提供下棋位置时，需要利用映射函数完成机械臂坐标系—电脑棋盘坐标系之间转换，映射函数如下：
$$
X: A = -2* B+10\\
Y: A = 2.5* B+10
$$
其中，A是机械臂坐标系中坐标，B是电脑棋盘坐标系的坐标。

##### 2.2 **正逆运动学控制**

这个是机械臂自带的控制函数，参数为坐标位置，输出为3、4、5、6号四个舵机的旋转角度。由于五子棋直径约为2.5cm，为了在放置其他棋子时不影响其他已放置棋子的状态，且能随距离远近调整高度，总结出如下方案：

放置高度与坐标关系：
$$
z = 0.05* y+1.5
$$
*fine-tunning:*

将机械臂到达指定位置后，调整3、4、5号舵机位置，并使前爪旋转45度，以斜侧入的形式进行放置。

##### 2.3 深度学习

这里使用深度学习的方式，学习目标是构建目标位置与3、4、5、6号舵机旋转角度的映射关系。

首先基于正逆运动学的方法，记录机械臂在9*9棋牌上，共81个位置的舵机信息，构造训练集，详见position.txt。

之后构建了三层感知机，学习映射函数，在windows10、pytorch环境下进行训练，并将模型最终部署到树莓派上得以使用。具体参数如下：

| 损失函数 | 学习率 | Epoch | 优化器 |  Loss  |
| :------: | :----: | :---: | :----: | :----: |
|   MSE    |  0.01  |  240  |  Adam  | 299.00 |

*只是这里简单的搭了个MLP，精读方面还有很大的提升空间*

#### 3 **实验结论**

  我们对五子棋的正反放置位置、放置坐标范围进行实验，得到以下结论：

1）   因为五子棋的正反两面质量不同（正面弧、背面平），所以喂给机械臂五子棋时需要将背面朝特定方位，使得五子棋放置时不会出现翻滚导致位置偏移；

2）   未进行坐标系转换时机械臂控制良好，进行转换后发现机械臂在X轴两侧均有误差，且随距原点越远误差越大，但总体仍处于可接受范围。经讨论，认为是由于机械臂下需放置棋盘，导致前后不水平，使映射呈非线性的状态。

###  四、其他

1. 因为采用pip安装的时候需要联网下载，而本身咱们是通过局域网连接树莓派服务器的，所以要解决上网问题：

   ​	（1）整根网线，插树莓派上

   ​	（2）利用蓝牙通信（听玩过平衡小车的同学说可以这么搞）

2. 外接摄像头需要额外购入，最好买固焦的摄像头。然后是插电脑主机上还是插树莓派上根据采用方法一还是方法二决定。不过，有些函数就需要变动，无法直接使用.

3. 各文件用途：

   - ANN.py :    深度学习代码
   - move.py：机械臂控制代码，包含正逆运动学和深度学习两个接口
   - my_model.pth:  深度学习训练的模型
   - position.txt :  9*9棋盘共81个位置，每个位置对应机械臂坐标系下位置坐标
   - train.txt : 81个位置各舵机的参数，深度学习训练集
   - sever.py: 服务器端代码
   - transmit.py:  客户端代码
